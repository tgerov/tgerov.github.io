<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>luks on /home/gerov</title><link>https://gerov.eu/tags/luks/</link><description>Recent content in luks on /home/gerov</description><generator>Hugo -- gohugo.io</generator><language>en-us</language><copyright>Copyright 2022 Tsvetan Gerov | All Content CC-BY-SA</copyright><lastBuildDate>Sat, 12 Feb 2022 00:00:00 +0000</lastBuildDate><atom:link href="https://gerov.eu/tags/luks/index.xml" rel="self" type="application/rss+xml"/><item><title>Unlock LUKs encrypted root filesystem remotely via SSH (RHEL 8/CentOS 8)</title><link>https://gerov.eu/posts/unlock-luks-encrypted-fs-remotetly-via-ssh/</link><pubDate>Sat, 12 Feb 2022 00:00:00 +0000</pubDate><guid>https://gerov.eu/posts/unlock-luks-encrypted-fs-remotetly-via-ssh/</guid><description>Unlock LUKS encrypted root file system remotely via SSH</description><content>&lt;h2 id="intruduction">Intruduction&lt;/h2>
&lt;p>In this short tutorial, I will show you how to unlock your luks encrypted root file system on RHEL 8 / CentOS 8, remotely via SSH. To accomplish this task, we will use 3rd party dracut module - dracut-sshd.&lt;/p>
&lt;p>Before we begin, we will need some details for our system - Ethernet device, IP address, NETMASK and Gateway.&lt;/p>
&lt;p>In this example my configuration is as follow:&lt;/p>
&lt;p>IP: 192.168.0.77&lt;br>
NETMASK: 255.255.0.0&lt;br>
GATEWAY: 192.168.0.1&lt;br>
Ethernet: eth0&lt;/p>
&lt;h2 id="generate-ssh-key-pair">Generate SSH key pair&lt;/h2>
&lt;p>We need to generate a public-private ssh keys and include them in initramfs.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>ssh-keygen -t rsa
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>ssh-copy-id -i ~/.ssh/id_rsa.pub root@192.168.0.77
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="install-dracut-sshd">Install dracut-sshd&lt;/h2>
&lt;p>This Dracut module (dracut-sshd) integrates the OpenSSH sshd into the initramfs. It allows for remote unlocking of a fully encrypted root filesystem and remote access to the Dracut emergency shell (i.e. early userspace). [1]&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>dnf copr enable gsauthof/dracut-sshd
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>dnf install dracut-sshd
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="enable-dracut-network">Enable dracut Network&lt;/h2>
&lt;p>Here, we add early network capabilities to initramfs.
Update network configuration to match your requirements.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>cat &lt;span style="color:#e6db74">&amp;lt;&amp;lt;EOF &amp;gt;&amp;gt; /etc/dracut.conf.d/99-network.conf
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74">kernel_cmdline=&amp;#34;ip=192.168.0.77::192.168.0.1:255.255.0.0:VerySecureVM:eth0:off&amp;#34;
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74">EOF&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Syntax is:&lt;/p>
&lt;pre tabindex="0">&lt;code>ip&amp;lt;client-IP-number&amp;gt;:[&amp;lt;server-id&amp;gt;]:&amp;lt;gateway-IP-number&amp;gt;:&amp;lt;netmask&amp;gt;:&amp;lt;client-hostname&amp;gt;:&amp;lt;interface&amp;gt;:{dhcp|dhcp6|auto6|on|any|none|off}
&lt;/code>&lt;/pre>&lt;h2 id="force-dracut-initram-regeneration">Force Dracut initram regeneration&lt;/h2>
&lt;p>In order to include our SSH keys and dracut network configuration, we will force dracut to regenerate initramfs image.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>dracut -f
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="flush-dracut-network-configuration">Flush Dracut network configuration&lt;/h2>
&lt;p>Since IP address configuration is set via kernel, NetworkManager will not load your configuration from real root filesystem. This will be a problem if you have IP aliasess, bonds, bridge, vlans &amp;amp; etc. configured on your real root.&lt;/p>
&lt;p>If your system has one IP address, you can skip these steps.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>cat &lt;span style="color:#e6db74">&amp;lt;&amp;lt;EOF &amp;gt;&amp;gt; /etc/systemd/system/flush-dracut-network\@.service
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74">[Unit]
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74">Description=Remove dracut&amp;#39;s network configuration for %I
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74">Before=network-pre.target
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74">Wants=network-pre.target
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74">[Service]
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74">ExecStartPre=/usr/sbin/ip address show %i
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74">ExecStart=/usr/sbin/ip -statistics address flush dev %i
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74">[Install]
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74">WantedBy=default.target
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74">EOF&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Enable systemd unit to flush dracut configuration on our ethernet interface.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>systemctl enable flush-dracut-network@eth0
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Reboot your machine and test : )&lt;/p>
&lt;p>Once the initrd load and network is fired up, you should be able to login via SSH and unlock your encrypted root file system with single command - systemd-tty-ask-password-agent. Here is an example:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>ssh root@192.168.0.77
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>initramfs-ssh:/root# systemd-tty-ask-password-agent
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Please enter passphrase &lt;span style="color:#66d9ef">for&lt;/span> disk QEMU_HARDDISK &lt;span style="color:#f92672">(&lt;/span>luks-01a6fbf5-779e-47c0-b7bd-efca0252d5d9&lt;span style="color:#f92672">)&lt;/span>! ********
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>initramfs-ssh:/root# Connection to 192.168.0.77 closed by remote host.
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Connection to 192.168.0.77 closed.
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>References:&lt;br>
[1] &lt;a href="https://github.com/gsauthof/dracut-sshd">https://github.com/gsauthof/dracut-sshd&lt;/a>&lt;br>
[2] &lt;a href="https://access.redhat.com/solutions/3017441">https://access.redhat.com/solutions/3017441&lt;/a>&lt;br>
[3] &lt;a href="https://unix.stackexchange.com/questions/506331/networkmanager-doesnt-change-ip-address-when-dracut-cmdline-provided-static-ip">https://unix.stackexchange.com/questions/506331/networkmanager-doesnt-change-ip-address-when-dracut-cmdline-provided-static-ip&lt;/a>&lt;br>
[4] Photo: &lt;a href="https://unsplash.com/photos/SZ98vfIx0pw">Markus Winkler&lt;/a>&lt;/p></content></item></channel></rss>