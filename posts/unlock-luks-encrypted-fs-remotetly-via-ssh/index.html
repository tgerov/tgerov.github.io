<!doctype html><html lang=en><head><title>Unlock LUKs encrypted root filesystem remotely via SSH (RHEL 8/CentOS 8) :: /home/gerov</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Unlock LUKS encrypted root file system remotely via SSH"><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=https://gerov.eu/posts/unlock-luks-encrypted-fs-remotetly-via-ssh/><link rel=stylesheet href=https://gerov.eu/assets/style.css><link rel=stylesheet href=https://gerov.eu/assets/green.css><link rel=apple-touch-icon href=https://gerov.eu/img/apple-touch-icon-192x192.png><link rel="shortcut icon" href=https://gerov.eu/img/favicon/green.png><meta name=twitter:card content="summary"><meta name=twitter:site content><meta name=twitter:creator content="Tsvetan Gerov"><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="og:title" content="Unlock LUKs encrypted root filesystem remotely via SSH (RHEL 8/CentOS 8)"><meta property="og:description" content="Unlock LUKS encrypted root file system remotely via SSH"><meta property="og:url" content="https://gerov.eu/posts/unlock-luks-encrypted-fs-remotetly-via-ssh/"><meta property="og:site_name" content="/home/gerov"><meta property="og:image" content="https://gerov.eu/img/favicon/green.png"><meta property="og:image:width" content="2048"><meta property="og:image:height" content="1024"><meta property="article:section" content="Linux"><meta property="article:published_time" content="2022-02-12 00:00:00 +0000 UTC"></head><body class=green><div class="container center headings--one-size"><header class=header><div class=header__inner><div class=header__logo><a href=/><div class=logo>üï∑Ô∏è /home/gerov</div></a></div><div class=menu-trigger>menu</div></div><nav class=menu><ul class="menu__inner menu__inner--desktop"><li><a href=/about>About</a></li><li><a href=/posts>Posts</a></li><li><a href=/tags>Tags</a></li></ul><ul class="menu__inner menu__inner--mobile"><li><a href=/about>About</a></li><li><a href=/posts>Posts</a></li><li><a href=/tags>Tags</a></li></ul></nav></header><div class=content><div class=post><h1 class=post-title><a href=https://gerov.eu/posts/unlock-luks-encrypted-fs-remotetly-via-ssh/>Unlock LUKs encrypted root filesystem remotely via SSH (RHEL 8/CentOS 8)</a></h1><div class=post-meta><span class=post-date>2022-02-12
[Updated: 2022-02-12]</span>
<span class=post-author>:: Tsvetan Gerov</span>
<span class=post-reading-time>:: 2 min read (364 words)</span></div><span class=post-tags>#<a href=https://gerov.eu/tags/linux/>linux</a>&nbsp;
#<a href=https://gerov.eu/tags/rhel/>rhel</a>&nbsp;
#<a href=https://gerov.eu/tags/centos/>centos</a>&nbsp;
#<a href=https://gerov.eu/tags/luks/>luks</a>&nbsp;</span>
<img src=/posts/unlock-luks-encrypted-fs-remotetly-via-ssh/cover.jpg class=post-cover alt="Unlock LUKs encrypted root filesystem remotely via SSH (RHEL 8/CentOS 8)" title="Cover Image"><div class=post-content><div><h2 id=intruduction>Intruduction<a href=#intruduction class=hanchor arialabel=Anchor>&#8983;</a></h2><p>In this short tutorial, I will show you how to unlock your luks encrypted root file system on RHEL 8 / CentOS 8, remotely via SSH. To accomplish this task, we will use 3rd party dracut module - dracut-sshd.</p><p>Before we begin, we will need some details for our system - Ethernet device, IP address, NETMASK and Gateway.</p><p>In this example my configuration is as follow:</p><p>IP: 192.168.0.77<br>NETMASK: 255.255.0.0<br>GATEWAY: 192.168.0.1<br>Ethernet: eth0</p><h2 id=generate-ssh-key-pair>Generate SSH key pair<a href=#generate-ssh-key-pair class=hanchor arialabel=Anchor>&#8983;</a></h2><p>We need to generate a public-private ssh keys and include them in initramfs.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ssh-keygen -t rsa 
</span></span><span style=display:flex><span>ssh-copy-id -i ~/.ssh/id_rsa.pub root@192.168.0.77
</span></span></code></pre></div><h2 id=install-dracut-sshd>Install dracut-sshd<a href=#install-dracut-sshd class=hanchor arialabel=Anchor>&#8983;</a></h2><p>This Dracut module (dracut-sshd) integrates the OpenSSH sshd into the initramfs. It allows for remote unlocking of a fully encrypted root filesystem and remote access to the Dracut emergency shell (i.e. early userspace). [1]</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>dnf copr enable gsauthof/dracut-sshd
</span></span><span style=display:flex><span>dnf install dracut-sshd
</span></span></code></pre></div><h2 id=enable-dracut-network>Enable dracut Network<a href=#enable-dracut-network class=hanchor arialabel=Anchor>&#8983;</a></h2><p>Here, we add early network capabilities to initramfs.
Update network configuration to match your requirements.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>cat <span style=color:#e6db74>&lt;&lt;EOF  &gt;&gt; /etc/dracut.conf.d/99-network.conf
</span></span></span><span style=display:flex><span><span style=color:#e6db74>kernel_cmdline=&#34;ip=192.168.0.77::192.168.0.1:255.255.0.0:VerySecureVM:eth0:off&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>EOF</span>
</span></span></code></pre></div><p>Syntax is:</p><pre tabindex=0><code>ip&lt;client-IP-number&gt;:[&lt;server-id&gt;]:&lt;gateway-IP-number&gt;:&lt;netmask&gt;:&lt;client-hostname&gt;:&lt;interface&gt;:{dhcp|dhcp6|auto6|on|any|none|off}
</code></pre><h2 id=force-dracut-initram-regeneration>Force Dracut initram regeneration<a href=#force-dracut-initram-regeneration class=hanchor arialabel=Anchor>&#8983;</a></h2><p>In order to include our SSH keys and dracut network configuration, we will force dracut to regenerate initramfs image.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>dracut -f
</span></span></code></pre></div><h2 id=flush-dracut-network-configuration>Flush Dracut network configuration<a href=#flush-dracut-network-configuration class=hanchor arialabel=Anchor>&#8983;</a></h2><p>Since IP address configuration is set via kernel, NetworkManager will not load your configuration from real root filesystem. This will be a problem if you have IP aliasess, bonds, bridge, vlans & etc. configured on your real root.</p><p>If your system has one IP address, you can skip these steps.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>cat <span style=color:#e6db74>&lt;&lt;EOF &gt;&gt; /etc/systemd/system/flush-dracut-network\@.service
</span></span></span><span style=display:flex><span><span style=color:#e6db74>[Unit]
</span></span></span><span style=display:flex><span><span style=color:#e6db74>Description=Remove dracut&#39;s network configuration for %I
</span></span></span><span style=display:flex><span><span style=color:#e6db74>Before=network-pre.target
</span></span></span><span style=display:flex><span><span style=color:#e6db74>Wants=network-pre.target
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>[Service]
</span></span></span><span style=display:flex><span><span style=color:#e6db74>ExecStartPre=/usr/sbin/ip address show %i
</span></span></span><span style=display:flex><span><span style=color:#e6db74>ExecStart=/usr/sbin/ip -statistics address flush dev %i
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>[Install]
</span></span></span><span style=display:flex><span><span style=color:#e6db74>WantedBy=default.target
</span></span></span><span style=display:flex><span><span style=color:#e6db74>EOF</span>
</span></span></code></pre></div><p>Enable systemd unit to flush dracut configuration on our ethernet interface.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>systemctl enable flush-dracut-network@eth0
</span></span></code></pre></div><p>Reboot your machine and test : )</p><p>Once the initrd load and network is fired up, you should be able to login via SSH and unlock your encrypted root file system with single command - systemd-tty-ask-password-agent. Here is an example:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ssh root@192.168.0.77
</span></span><span style=display:flex><span>initramfs-ssh:/root# systemd-tty-ask-password-agent
</span></span><span style=display:flex><span>Please enter passphrase <span style=color:#66d9ef>for</span> disk QEMU_HARDDISK <span style=color:#f92672>(</span>luks-01a6fbf5-779e-47c0-b7bd-efca0252d5d9<span style=color:#f92672>)</span>! ********
</span></span><span style=display:flex><span>initramfs-ssh:/root# Connection to 192.168.0.77 closed by remote host.
</span></span><span style=display:flex><span>Connection to 192.168.0.77 closed.
</span></span></code></pre></div><p>References:<br>[1] <a href=https://github.com/gsauthof/dracut-sshd>https://github.com/gsauthof/dracut-sshd</a><br>[2] <a href=https://access.redhat.com/solutions/3017441>https://access.redhat.com/solutions/3017441</a><br>[3] <a href=https://unix.stackexchange.com/questions/506331/networkmanager-doesnt-change-ip-address-when-dracut-cmdline-provided-static-ip>https://unix.stackexchange.com/questions/506331/networkmanager-doesnt-change-ip-address-when-dracut-cmdline-provided-static-ip</a><br>[4] Photo: <a href=https://unsplash.com/photos/SZ98vfIx0pw>Markus Winkler</a></p></div></div><div class=pagination><div class=pagination__title><span class=pagination__title-h>Read other posts</span><hr></div><div class=pagination__buttons><span class="button previous"><a href=https://gerov.eu/posts/2022/how-to-install-seafile-on-fedora/><span class=button__icon>‚Üê</span>
<span class=button__text>How to install Seafile on Fedora</span></a></span>
<span class="button next"><a href=https://gerov.eu/posts/traefik-for-podman/><span class=button__text>How To Use Traefik as a Reverse Proxy for Podman (rootless)</span>
<span class=button__icon>‚Üí</span></a></span></div></div></div></div><footer class=footer><div class=footer__inner><div class="copyright copyright--user"><span>Copyright 2022 Tsvetan Gerov | All Content CC-BY-SA</span>
<span>:: Theme made by <a href=https://twitter.com/panr>panr</a></span></div></div></footer><script src=https://gerov.eu/assets/main.js></script>
<script src=https://gerov.eu/assets/prism.js></script></div></body></html>